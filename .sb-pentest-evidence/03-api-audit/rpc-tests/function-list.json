{
  "audit_timestamp": "2026-02-02T00:00:00Z",
  "project_id": "qqhtcsbwjwoendqnwkld",
  "total_functions": 20,
  "callable_functions": 15,
  "trigger_functions": 5,
  "functions": [
    {
      "name": "analyze_table",
      "args": "table_name text",
      "return_type": "void",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "Whitelist-based ANALYZE. Accepts text param but validates against allowlist."
    },
    {
      "name": "decrement_unread_count",
      "args": "p_conversation_id uuid, p_amount integer DEFAULT 1",
      "return_type": "inbox_conversations",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "UUID param (type-safe). Updates unread count."
    },
    {
      "name": "ensure_default_ai_agent",
      "args": "",
      "return_type": "trigger",
      "security_definer": false,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "Trigger function. Not callable via RPC."
    },
    {
      "name": "get_agent_config",
      "args": "p_conversation_id uuid",
      "return_type": "json",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "UUID param (type-safe). Returns agent config for conversation."
    },
    {
      "name": "get_campaign_contact_stats",
      "args": "p_campaign_id text",
      "return_type": "json",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "Text param used in WHERE clause (parameterized, not concatenated)."
    },
    {
      "name": "get_campaigns_with_all_tags",
      "args": "p_tag_ids uuid[]",
      "return_type": "text[]",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "UUID array param (type-safe)."
    },
    {
      "name": "get_contact_stats",
      "args": "",
      "return_type": "json",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "No params. Returns aggregate stats. No auth.uid() check but access restricted by grants."
    },
    {
      "name": "get_contact_tags",
      "args": "",
      "return_type": "json",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "No params. Returns distinct tags."
    },
    {
      "name": "get_dashboard_stats",
      "args": "",
      "return_type": "TABLE(...)",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "Returns aggregate dashboard stats. No auth.uid() but single-tenant + grant-restricted."
    },
    {
      "name": "increment_campaign_stat (text overload)",
      "args": "campaign_id_input text, field text",
      "return_type": "void",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "Text 'field' param used in IF/ELSIF chain (safe, not interpolated into SQL)."
    },
    {
      "name": "increment_campaign_stat (uuid overload)",
      "args": "p_campaign_id uuid, p_stat text, p_value integer DEFAULT 1",
      "return_type": "void",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "⚠️ P2 INFO: Uses format(%I) with p_stat text param in dynamic SQL. Safe against injection due to %I quoting, but allows updating arbitrary columns if caller provides unexpected column name. Grant-restricted mitigates this."
    },
    {
      "name": "increment_conversation_counters",
      "args": "p_conversation_id uuid, p_direction text, p_message_preview text",
      "return_type": "inbox_conversations",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "Text params used in parameterized queries (safe)."
    },
    {
      "name": "process_inbound_message",
      "args": "p_phone text, p_content text, ...",
      "return_type": "json",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "Complex function with multiple text params. All used in parameterized queries (safe)."
    },
    {
      "name": "reset_unread_count",
      "args": "p_conversation_id uuid",
      "return_type": "inbox_conversations",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "UUID param (type-safe)."
    },
    {
      "name": "search_embeddings (5-param overload)",
      "args": "query_embedding vector, agent_id_filter uuid, expected_dimensions integer, ...",
      "return_type": "TABLE(id uuid, content text, similarity double precision, metadata jsonb)",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "Typed params (vector, uuid, int, float). Safe."
    },
    {
      "name": "search_embeddings (4-param overload)",
      "args": "query_embedding vector, match_threshold float, match_count integer, p_agent_id uuid",
      "return_type": "TABLE(id uuid, content text, metadata jsonb, similarity double precision)",
      "security_definer": true,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "Typed params. Safe."
    },
    {
      "name": "update_attendant_tokens_updated_at",
      "args": "",
      "return_type": "trigger",
      "security_definer": false,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "Trigger function. Not callable via RPC."
    },
    {
      "name": "update_campaign_dispatch_metrics",
      "args": "",
      "return_type": "trigger",
      "security_definer": false,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "Trigger function. Not callable via RPC."
    },
    {
      "name": "update_campaign_folders_updated_at",
      "args": "",
      "return_type": "trigger",
      "security_definer": false,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "Trigger function. Not callable via RPC."
    },
    {
      "name": "update_updated_at_column",
      "args": "",
      "return_type": "trigger",
      "security_definer": false,
      "language": "plpgsql",
      "grants": { "anon": false, "authenticated": false, "service_role": true },
      "anon_accessible": false,
      "notes": "Trigger function. Not callable via RPC."
    }
  ]
}
