{
  "rpc_audit": {
    "timestamp": "2026-02-02T00:00:00Z",
    "project_id": "qqhtcsbwjwoendqnwkld",
    "functions_found": 20,
    "callable_functions": 15,
    "trigger_functions": 5,
    "summary": {
      "safe": 20,
      "p0_critical": 0,
      "p1_high": 0,
      "p2_info": 1
    },
    "access_control": {
      "anon_accessible": 0,
      "authenticated_accessible": 0,
      "service_role_only": 20
    },
    "findings": [
      {
        "function": "increment_campaign_stat (uuid overload)",
        "severity": "P2-INFO",
        "issue": "Dynamic SQL with format(%I, p_stat) allows updating arbitrary column names if called with unexpected input",
        "impact": "Mitigated: only service_role can execute. No direct exploitation path via API.",
        "remediation": "Consider adding a whitelist check for p_stat values (sent, delivered, read, failed) similar to the text overload's IF/ELSIF pattern"
      }
    ],
    "security_highlights": {
      "all_functions_grant_restricted": true,
      "no_anon_access": true,
      "no_authenticated_access": true,
      "security_definer_count": 15,
      "security_invoker_count": 5,
      "search_path_set": true,
      "sql_injection_vectors": 0
    }
  },
  "rls_audit": {
    "timestamp": "2026-02-02T00:05:00Z",
    "project_id": "qqhtcsbwjwoendqnwkld",
    "tables_audited": 38,
    "summary": {
      "rls_enabled": 38,
      "rls_disabled": 0,
      "with_anon_select_policy": 7,
      "fully_blocked": 31,
      "write_operations_blocked": 38
    },
    "severity_breakdown": {
      "p0_critical": 0,
      "p1_high": 3,
      "p2_medium": 3,
      "p3_low": 1
    },
    "findings": [
      {
        "table": "contacts",
        "severity": "P1-HIGH",
        "issue": "Anon SELECT with USING(true) exposes all contacts with PII (name, phone, email)",
        "current_rows": 0,
        "impact": "All contact PII readable by anyone with the anon key",
        "remediation": "DROP POLICY anon_select_contacts ON contacts; REVOKE SELECT ON contacts FROM anon;"
      },
      {
        "table": "inbox_conversations",
        "severity": "P1-HIGH",
        "issue": "Anon SELECT with USING(true) exposes conversation metadata (phone, message previews)",
        "current_rows": 0,
        "impact": "Private communication metadata accessible",
        "remediation": "DROP POLICY anon_select_inbox_conversations ON inbox_conversations; REVOKE SELECT ON inbox_conversations FROM anon;"
      },
      {
        "table": "inbox_messages",
        "severity": "P1-HIGH",
        "issue": "Anon SELECT with USING(true) exposes full message content and media URLs",
        "current_rows": 0,
        "impact": "Private message content accessible",
        "remediation": "DROP POLICY anon_select_inbox_messages ON inbox_messages; REVOKE SELECT ON inbox_messages FROM anon;"
      },
      {
        "table": "campaigns",
        "severity": "P2-MEDIUM",
        "issue": "Anon SELECT with USING(true) exposes campaign data",
        "current_rows": 0,
        "impact": "Business intelligence leakage",
        "remediation": "DROP POLICY anon_select_campaigns ON campaigns; REVOKE SELECT ON campaigns FROM anon;"
      },
      {
        "table": "templates",
        "severity": "P2-MEDIUM",
        "issue": "Anon SELECT with USING(true) exposes 74 template definitions",
        "current_rows": 74,
        "impact": "Template body content and communication patterns exposed",
        "remediation": "DROP POLICY anon_select_templates ON templates; REVOKE SELECT ON templates FROM anon;"
      },
      {
        "table": "flows",
        "severity": "P2-MEDIUM",
        "issue": "Anon SELECT with USING(true) exposes flow automation logic",
        "current_rows": 0,
        "impact": "Automation logic and specs readable",
        "remediation": "DROP POLICY anon_select_flows ON flows; REVOKE SELECT ON flows FROM anon;"
      },
      {
        "table": "account_alerts",
        "severity": "P3-LOW",
        "issue": "Anon SELECT with USING(true) exposes account health alerts",
        "current_rows": 0,
        "impact": "System health information accessible",
        "remediation": "DROP POLICY anon_select_account_alerts ON account_alerts; REVOKE SELECT ON account_alerts FROM anon;"
      }
    ]
  }
}
